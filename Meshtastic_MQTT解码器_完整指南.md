# ğŸ“¡ Meshtastic MQTTè§£ç å™¨ - å®Œæ•´æŒ‡å—

## ğŸ¯ é¡¹ç›®æ¦‚è¿°

è¿™æ˜¯ä¸€ä¸ª**å®Œå…¨ç‹¬ç«‹**çš„Meshtastic MQTTæ¶ˆæ¯è§£ç å·¥å…·ï¼Œæ— éœ€ä¾èµ–ä»»ä½•Meshtasticåº“ã€protobufåº“æˆ–PlatformIOç¯å¢ƒã€‚é‡‡ç”¨æ‰‹åŠ¨å®ç°çš„protobufè§£æå™¨ï¼Œæ”¯æŒServiceEnvelopeå’ŒMeshPacketæ ¼å¼è§£æã€‚

### âœ¨ æ ¸å¿ƒç‰¹ç‚¹
- âœ… **é›¶ä¾èµ–** - æ— éœ€å®‰è£…ä»»ä½•åº“æˆ–ç¯å¢ƒ
- âœ… **å®Œå…¨ç‹¬ç«‹** - è„±ç¦»Meshtasticé¡¹ç›®è¿è¡Œ
- âœ… **å•æ–‡ä»¶è¿è¡Œ** - 2.7MBé™æ€ç¼–è¯‘exeæ–‡ä»¶
- âœ… **è·¨å¹³å°ç§»æ¤** - å¯å¤åˆ¶åˆ°ä»»ä½•Windowsç³»ç»Ÿ
- âœ… **åŒè¯­æ”¯æŒ** - ä¸­è‹±æ–‡ç•Œé¢å¯é€‰
- âœ… **æºç å¼€æ”¾** - å®Œæ•´æºç å¯ä¿®æ”¹æ‰©å±•

---

## ğŸ“ é¡¹ç›®ç»“æ„è¯´æ˜

æœ¬é¡¹ç›®åŒ…å«ä¸¤ä¸ªç‹¬ç«‹çš„è§£ç å™¨ç‰ˆæœ¬ï¼š

### ğŸ”§ `decoder_portable/` - ç‹¬ç«‹ç‰ˆæœ¬ (æ¨è)
**å®Œå…¨è„±ç¦»Meshtasticé¡¹ç›®çš„ç‹¬ç«‹è§£ç å™¨**
- âœ… é›¶å¤–éƒ¨ä¾èµ–
- âœ… å¯å¤åˆ¶åˆ°ä»»ä½•ç”µè„‘ä½¿ç”¨
- âœ… æ— ä¹±ç ç‰ˆæœ¬å¯ç”¨

### ğŸ—ï¸ `meshtastic_decoder/` - åº“ä¾èµ–ç‰ˆæœ¬
**åŸºäºMeshtasticé¡¹ç›®åº“çš„è§£ç å™¨**
- âš ï¸ éœ€è¦Meshtasticé¡¹ç›®ç¯å¢ƒ
- âš ï¸ å¯èƒ½æœ‰ç¼–ç é—®é¢˜

---

## ğŸš€ æ¨èä½¿ç”¨æ–¹å¼

### **æœ€ä½³é€‰æ‹©: ç‹¬ç«‹ç‰ˆæœ¬**
```
è¿›å…¥ decoder_portable/ æ–‡ä»¶å¤¹
åŒå‡»: start_clean_decoder.bat
```

**æˆ–è€…ï¼š**
```
è¿›å…¥ decoder_portable/ æ–‡ä»¶å¤¹
åŒå‡»: mqtt_decoder_clean.exe
```

### **é‡æ–°ç¼–è¯‘ (å¦‚éœ€ä¿®æ”¹)**
```
è¿›å…¥ decoder_portable/ æ–‡ä»¶å¤¹
è¿è¡Œ: build.bat
é€‰æ‹©: 1 (Clean English version)
```

---

## ğŸ“ ä½¿ç”¨æ–¹æ³•

### åŸºæœ¬ä½¿ç”¨æµç¨‹
1. **è¿›å…¥ç‹¬ç«‹ç‰ˆæœ¬æ–‡ä»¶å¤¹** - `decoder_portable/`
2. **å¯åŠ¨ç¨‹åº** - åŒå‡» `start_clean_decoder.bat`
3. **è¾“å…¥MQTTæ•°æ®** - ç²˜è´´åå…­è¿›åˆ¶æ¶ˆæ¯æ•°æ®
4. **è¾“å…¥é¢„æœŸå†…å®¹** - å¸®åŠ©éªŒè¯è§£æç»“æœ
5. **è¾“å…¥PSKä¿¡æ¯** - ä½¿ç”¨PSK #1æˆ–è‡ªå®šä¹‰PSK
6. **æŸ¥çœ‹è§£æç»“æœ** - ç¨‹åºæ˜¾ç¤ºè¯¦ç»†è§£æä¿¡æ¯

### ç¤ºä¾‹æ“ä½œ

#### å¯åŠ¨ç¨‹åºåçš„ç•Œé¢ï¼š
```
=================================
    Meshtastic MQTT Decoder      
=================================
Enter MQTT message hex data for decoding
Supports ServiceEnvelope format protobuf messages
=================================

Enter MQTT message hex data (type 'quit' to exit):
>
```

#### è¾“å…¥æ•°æ®ï¼š
```
MQTTæ•°æ®: 0a25 0dc0 579c 8415 ffff ffff 2205 0801 1201 3135 4b9f de24 3d95 846f 6848 0358 6478 0398 01c0 0112 0953 686f 7274 536c 6f77 1a09 2138 3439 6335 3763 30

é¢„æœŸå†…å®¹: 1
PSK: AQ==
```

#### ç¨‹åºè¾“å‡ºï¼š
```
=== ServiceEnvelope Parsing ===
SUCCESS: Found MeshPacket (37 bytes)
SUCCESS: Channel ID: ShortSlow
SUCCESS: Gateway ID: !849c57c0

=== MeshPacket Parsing ===
SUCCESS: From: 0x849c57c0 (!849c57c0)
SUCCESS: To: 0xffffffff (broadcast)
SUCCESS: Encrypted data: 5 bytes

=== Parsing Results Summary ===
Source node: !849c57c0
Target: broadcast message
Channel: ShortSlow
Gateway: !849c57c0
```

### PSKè¾“å…¥è¯´æ˜
- **`AQ==`** - ä½¿ç”¨PSK #1 (é»˜è®¤å…±äº«å¯†é’¥)
- **`d4f1bb3a2029075...`** - è¾“å…¥16å­—èŠ‚è‡ªå®šä¹‰PSKçš„hexå­—ç¬¦ä¸²

---

## ğŸ”§ æŠ€æœ¯å®ç°åŸç†

### ç‹¬ç«‹å®ç° vs ä¼ ç»Ÿæ–¹å¼

#### âŒ ä¼ ç»Ÿæ–¹å¼ï¼ˆéœ€è¦ä¾èµ–ï¼‰
```cpp
// éœ€è¦å¤§é‡ä¾èµ–åº“
#include "src/mesh/generated/meshtastic/mesh.pb.h"
#include "src/mesh/generated/meshtastic/mqtt.pb.h"  
#include <pb_decode.h>

// å¤æ‚çš„æ„å»ºç³»ç»Ÿ
meshtastic_ServiceEnvelope envelope;
pb_decode(&stream, &meshtastic_ServiceEnvelope_msg, &envelope);
```

#### âœ… æˆ‘ä»¬çš„æ–¹å¼ï¼ˆå®Œå…¨ç‹¬ç«‹ï¼‰
```cpp
// åªä½¿ç”¨æ ‡å‡†C++åº“
#include <iostream>
#include <vector>
#include <string>

// æ‰‹åŠ¨å®ç°protobufè§£æ
uint64_t decodeVarint(const uint8_t*& data, size_t& remaining);
ServiceEnvelope parseServiceEnvelope(const uint8_t* data, size_t length);
```

### æ ¸å¿ƒæŠ€æœ¯ç»„ä»¶

#### 1. æ‰‹åŠ¨Protobufè§£æå™¨
```cpp
// varintè§£ç å®ç°
uint64_t decodeVarint(const uint8_t*& data, size_t& remaining) {
    uint64_t result = 0;
    int shift = 0;
    
    while (remaining > 0 && shift < 64) {
        uint8_t byte = *data++;
        remaining--;
        result |= ((uint64_t)(byte & 0x7F)) << shift;
        if ((byte & 0x80) == 0) break;
        shift += 7;
    }
    return result;
}
```

#### 2. è‡ªå®šä¹‰ç»“æ„ä½“å®šä¹‰
```cpp
// æ‰‹åŠ¨å®šä¹‰ï¼Œæ— éœ€.protoæ–‡ä»¶
struct ServiceEnvelope {
    vector<uint8_t> packetData;  // field 1
    string channelId;            // field 2  
    string gatewayId;            // field 3
    bool valid = false;
};

struct MeshPacket {
    uint32_t from = 0;           // field 1
    uint32_t to = 0;             // field 2
    vector<uint8_t> encryptedData; // field 4
    uint64_t id = 0;             // field 6
};
```

#### 3. å†…ç½®PSKå¤„ç†
```cpp
// å†…ç½®é»˜è®¤PSKï¼Œæ— éœ€å¤–éƒ¨é…ç½®
const uint8_t defaultpsk[] = {
    0xd4, 0xf1, 0xbb, 0x3a, 0x20, 0x29, 0x07, 0x59,
    0xf0, 0xbc, 0xff, 0xab, 0xcf, 0x4e, 0x69, 0x01
};
```

---

## ğŸ“ è¯¦ç»†é¡¹ç›®ç»“æ„

```
meshtastic_f/
â”œâ”€â”€ Meshtastic_MQTTè§£ç å™¨_å®Œæ•´æŒ‡å—.md  # æœ¬æ–‡æ¡£
â”œâ”€â”€ decoder_portable/              # ğŸ”¥ ç‹¬ç«‹ç‰ˆæœ¬ (æ¨èä½¿ç”¨)
â”‚   â”œâ”€â”€ start_clean_decoder.bat    # æ— ä¹±ç å¯åŠ¨è„šæœ¬
â”‚   â”œâ”€â”€ mqtt_decoder_clean.exe     # æ— ä¹±ç ç‰ˆæœ¬ (æ¨è)
â”‚   â”œâ”€â”€ mqtt_decoder_en.exe        # è‹±æ–‡ç‰ˆæœ¬
â”‚   â”œâ”€â”€ mqtt_decoder_cn.exe        # ä¸­æ–‡ç‰ˆæœ¬
â”‚   â”œâ”€â”€ build.bat                  # ç¼–è¯‘è„šæœ¬
â”‚   â”œâ”€â”€ README_Clean.md            # ç‹¬ç«‹ç‰ˆæœ¬è¯´æ˜
â”‚   â””â”€â”€ src/                       # æºç ç›®å½•
â”‚       â”œâ”€â”€ mqtt_decoder_clean_en.cpp  # æ— ä¹±ç æºç 
â”‚       â”œâ”€â”€ mqtt_decoder_en.cpp    # è‹±æ–‡ç‰ˆæºç 
â”‚       â””â”€â”€ mqtt_decoder_cn.cpp    # ä¸­æ–‡ç‰ˆæºç 
â””â”€â”€ meshtastic_decoder/            # åº“ä¾èµ–ç‰ˆæœ¬ (å¼€å‘ç”¨)
    â”œâ”€â”€ mqtt_decoder.cpp           # åŸå§‹æºç 
    â””â”€â”€ README.md                  # åº“ä¾èµ–ç‰ˆæœ¬è¯´æ˜
```

---

## ğŸ›  é—®é¢˜è§£å†³æ–¹æ¡ˆ

### âœ… å·²è§£å†³çš„é—®é¢˜

| é—®é¢˜ | è§£å†³æ–¹æ¡ˆ | çŠ¶æ€ |
|------|----------|------|
| **ä¹±ç æ˜¾ç¤º** | åˆ›å»ºcleanç‰ˆæœ¬ | âœ… å®Œå…¨è§£å†³ |
| **å…¥å£ç‚¹é”™è¯¯** | é™æ€ç¼–è¯‘é“¾æ¥ | âœ… å®Œå…¨è§£å†³ |
| **è·¯å¾„é—®é¢˜** | ç‹¬ç«‹æ–‡ä»¶å¤¹ç»“æ„ | âœ… å®Œå…¨è§£å†³ |
| **æºç ä¿ç•™** | å¤šç‰ˆæœ¬æºç ä¿å­˜ | âœ… å®Œå…¨è§£å†³ |
| **ä¾èµ–é—®é¢˜** | å®Œå…¨ç‹¬ç«‹å®ç° | âœ… å®Œå…¨è§£å†³ |
| **é¡¹ç›®æ±¡æŸ“** | ç‹¬ç«‹æ–‡ä»¶å¤¹ç®¡ç† | âœ… å®Œå…¨è§£å†³ |

### ä½¿ç”¨å»ºè®®
1. **é¦–é€‰ç‹¬ç«‹ç‰ˆæœ¬** - ä½¿ç”¨ `decoder_portable/` æ–‡ä»¶å¤¹
2. **ä½¿ç”¨cleanç‰ˆæœ¬** - å®Œå…¨æ— ä¹±ç é—®é¢˜
3. **ä¿æŒæ–‡ä»¶å¤¹ç»“æ„** - ä¸è¦ç§»åŠ¨æ–‡ä»¶åˆ°æ ¹ç›®å½•
4. **å‚è€ƒç›¸åº”README** - å„æ–‡ä»¶å¤¹æœ‰ä¸“é—¨çš„è¯´æ˜æ–‡æ¡£

---

## ğŸ”¬ å¼€å‘è€…æŒ‡å—

### ä¿®æ”¹æºç 
1. è¿›å…¥ `decoder_portable/` æ–‡ä»¶å¤¹
2. ç¼–è¾‘ `src/mqtt_decoder_clean_en.cpp` (æ¨èç‰ˆæœ¬)
3. è¿è¡Œ `build.bat` é‡æ–°ç¼–è¯‘
4. é€‰æ‹©è¦è®¾ä¸ºé»˜è®¤çš„ç‰ˆæœ¬

### æ·»åŠ æ–°åŠŸèƒ½
æºç é‡‡ç”¨æ¨¡å—åŒ–è®¾è®¡ï¼Œä¸»è¦å‡½æ•°ï¼š
- `hexToBytes()` - åå…­è¿›åˆ¶å­—ç¬¦ä¸²è½¬æ¢
- `parseServiceEnvelope()` - ServiceEnvelopeè§£æ
- `parseMeshPacket()` - MeshPacketè§£æ
- `analyzeEncryptedData()` - åŠ å¯†æ•°æ®åˆ†æ
- `getPSKFromInput()` - PSKè¾“å…¥å¤„ç†

### æ‰©å±•å»ºè®®
å¯ä»¥ç»§ç»­æ·»åŠ çš„åŠŸèƒ½ï¼š
- çœŸæ­£çš„AES-CTRè§£å¯†å®ç°
- JSONæ ¼å¼è¾“å‡ºé€‰é¡¹
- æ‰¹é‡å¤„ç†MQTTæ—¥å¿—æ–‡ä»¶
- æ›´å¤šæ¶ˆæ¯ç±»å‹è§£æ
- Webç•Œé¢ç‰ˆæœ¬

---

## ğŸ“Š æŠ€æœ¯å¯¹æ¯”

| ç‰¹å¾ | Meshtasticå®˜æ–¹ | æœ¬è§£ç å™¨ |
|------|----------------|----------|
| **protobufè§£æ** | nanpbåº“ + .protoæ–‡ä»¶ | æ‰‹åŠ¨å®ç° |
| **ç¼–è¯‘ä¾èµ–** | PlatformIO + å¤šä¸ªåº“ | ä»…g++ |
| **è¿è¡Œç¯å¢ƒ** | å®Œæ•´å¼€å‘ç¯å¢ƒ | å•exeæ–‡ä»¶ |
| **æ–‡ä»¶å¤§å°** | éœ€å¤–éƒ¨åº“ | 2.7MBè‡ªåŒ…å« |
| **ç§»æ¤æ€§** | éœ€è¦ç¯å¢ƒé…ç½® | å³å¤åˆ¶å³ç”¨ |
| **å­¦ä¹ æˆæœ¬** | é«˜ï¼ˆéœ€äº†è§£æ•´ä¸ªç³»ç»Ÿï¼‰ | ä½ï¼ˆå•æ–‡ä»¶ç†è§£ï¼‰ |

---

## ğŸ ç‹¬ç«‹æ€§éªŒè¯

### éªŒè¯æ­¥éª¤
1. å°† `decoder_portable/` æ–‡ä»¶å¤¹å¤åˆ¶åˆ°ä»»ä½•Windowsç”µè„‘
2. åŒå‡» `start_clean_decoder.bat` 
3. æ— éœ€å®‰è£…Meshtasticã€PlatformIOæˆ–ä»»ä½•ä¾èµ–åº“
4. ç¨‹åºæ­£å¸¸è¿è¡Œï¼Œå®Œå…¨è„±ç¦»åŸé¡¹ç›®ç¯å¢ƒ

### æŠ€æœ¯è¯æ˜
- âœ… é›¶å¤–éƒ¨ä¾èµ–
- âœ… é™æ€ç¼–è¯‘åŒ…å«æ‰€æœ‰åº“
- âœ… æ‰‹åŠ¨å®ç°æ‰€æœ‰è§£æé€»è¾‘
- âœ… å†…ç½®æ‰€æœ‰å¿…è¦çš„å¸¸é‡å’Œæ•°æ®ç»“æ„

---

## ğŸ’¡ ä½¿ç”¨æç¤º

### æœ€ä½³å®è·µ
1. **ä½¿ç”¨ç‹¬ç«‹ç‰ˆæœ¬** - è¿›å…¥ `decoder_portable/` æ–‡ä»¶å¤¹
2. **é¦–é€‰cleanç‰ˆæœ¬** - å®Œå…¨æ— ç¼–ç é—®é¢˜
3. **ä¿æŒæ–‡ä»¶å¤¹å®Œæ•´æ€§** - ä¸è¦ç§»åŠ¨å•ä¸ªæ–‡ä»¶
4. **å‚è€ƒå¯¹åº”æ–‡æ¡£** - å„ç‰ˆæœ¬æœ‰ä¸“é—¨çš„è¯´æ˜

### å¸¸è§é—®é¢˜
- **Q: ç¨‹åºæ˜¾ç¤ºä¹±ç ï¼Ÿ** A: ä½¿ç”¨ `decoder_portable/mqtt_decoder_clean.exe`
- **Q: ç¨‹åºæ‰¾ä¸åˆ°ï¼Ÿ** A: ç¡®è®¤åœ¨æ­£ç¡®çš„æ–‡ä»¶å¤¹ (`decoder_portable/`)
- **Q: è§£æå¤±è´¥ï¼Ÿ** A: æ£€æŸ¥MQTTæ•°æ®æ ¼å¼å’ŒPSKè¾“å…¥
- **Q: éœ€è¦ä¿®æ”¹ï¼Ÿ** A: ç¼–è¾‘ `decoder_portable/src/` ä¸‹æºç åé‡æ–°ç¼–è¯‘

---

## ğŸ‰ é¡¹ç›®æˆå°±

### æŠ€æœ¯çªç ´
1. **å®Œå…¨ç‹¬ç«‹** - å®ç°äº†çœŸæ­£çš„é›¶ä¾èµ–è§£ç å™¨
2. **æ‰‹åŠ¨å®ç°** - ä»é›¶æ„å»ºprotobufè§£æèƒ½åŠ›
3. **ç”¨æˆ·å‹å¥½** - è§£å†³äº†æ‰€æœ‰å·²çŸ¥çš„ä½¿ç”¨é—®é¢˜
4. **é«˜å¯ç§»æ¤** - å•æ–‡ä»¶åˆ†å‘ï¼Œå³å¤åˆ¶å³ç”¨
5. **é¡¹ç›®ç»“æ„æ¸…æ™°** - ç‹¬ç«‹æ–‡ä»¶å¤¹ç®¡ç†ï¼Œä¸æ±¡æŸ“ä¸»é¡¹ç›®

### å®ç”¨ä»·å€¼
- é€‚åˆå¿«é€Ÿåˆ†æMeshtastic MQTTæµé‡
- ä¾¿äºç†è§£Meshtasticæ¶ˆæ¯æ ¼å¼
- å¯ä½œä¸ºå­¦ä¹ protobufè§£æçš„ç¤ºä¾‹
- ä¸ºè¿›ä¸€æ­¥å¼€å‘æä¾›äº†ç‹¬ç«‹åŸºç¡€

**ğŸš€ æ¨èä½¿ç”¨ç‹¬ç«‹ç‰ˆæœ¬: `decoder_portable/start_clean_decoder.bat`** 